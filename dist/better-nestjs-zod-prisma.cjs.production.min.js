"use strict";var e=require("@prisma/generator-helper"),t=require("ts-morph"),a=require("typescript"),n=require("zod");function r(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var o=r(require("path"));const i=n.z.enum(["true","false"]).transform((e=>"true"===e)),s=n.z.object({relationModel:i.default("true").or(n.z.literal("default")),generateDto:i.default("true"),modelSuffix:n.z.string().default("Model"),dtoSuffix:n.z.string().default("Dto"),modelCase:n.z.enum(["PascalCase","camelCase"]).default("PascalCase"),dtoCase:n.z.enum(["PascalCase","camelCase"]).default("PascalCase"),useDecimalJs:i.default("false"),imports:n.z.string().optional(),prismaJsonNullability:i.default("true"),enableOpenAPI:i.default("false")});var l;!function(e){e.Start="@z.",e.Append="@z&."}(l||(l={}));const d={[l.Start]:1,[l.Append]:3};function c(e,t){return!function(e,t=Object.values(l)){return t.some((t=>e.trim().startsWith(t)))}(e,t)}function m(e,t){for(const a of e)if(!c(a,[t]))return a.trim().slice(d[t]);return null}const u=e=>{const t=[];if(e){const a=e.split("\n").filter((e=>c(e)));a.length>0&&(t.push("/**"),a.forEach((e=>t.push(` * ${e}`))),t.push(" */"))}return t},p={String:"z.string()",Int:"z.number().int()",BigInt:"z.bigint()",DateTime:"z.date()",Float:"z.number()",Decimal:"z.number()",Json:"z.string()",Boolean:"z.boolean()",Bytes:"z.instanceOf(Buffer)"},f=(e,t=(e=>e.toString()))=>{let a;a="scalar"===e.kind&&"string"==typeof e.type&&Object.prototype.hasOwnProperty.call(p,e.type)?p[e.type]:"enum"===e.kind?`z.nativeEnum($Enums.${e.type})`:"object"===e.kind?t(e.type):"z.unknown()";let n=!1;if(e.documentation){const t=m(e.documentation.split("\n"),l.Start),r=function(e){const t=[];for(const a of e.split("\n")){const e=m([a],l.Append);e&&t.push(e)}return t}(e.documentation);t&&(n=!0,a=t);for(const e of r)a+=e}return e.isList&&!n&&(a+=".array()"),e.isRequired||"Json"===e.type||(a+=".nullable()"),a},h=(e,t,a=!0)=>t.forEach((t=>e.write(t).conditionalNewLine(a))),S=({modelCase:e,modelSuffix:t,dtoSuffix:a,dtoCase:n,relationModel:r})=>{const o=(a,n="")=>{let r=a;return"camelCase"===e&&(r=r.slice(0,1).toLowerCase()+r.slice(1)),`${n}${r}${t}`};return{modelName:e=>o(e,"default"===r?"_":""),dtoName:e=>(e=>{let t=e;return"camelCase"===n&&(t=t.slice(0,1).toLowerCase()+t.slice(1)),`${t}${a}`})(e),relatedModelName:e=>o("default"===r?e.toString():`Related${e.toString()}`)}},z=e=>{const t=e.replace(/^\\\\\?\\/,"").replace(/\\/g,"/").replace(/\/\/+/g,"/");return t.includes("/node_modules/")?t.split("/node_modules/").slice(-1)[0]:t.startsWith("../")?t:"./"+t},{version:y}=require("../package.json");e.generatorHandler({onManifest:()=>({version:y,prettyName:"NestJS Zod Schemas",defaultOutput:"./src/zod"}),onGenerate(e){const n=new t.Project,r=e.dmmf.datamodel.models,i=e.dmmf.datamodel.enums,{schemaPath:l}=e,d=e.generator.output.value,c=e.otherGenerators.find((e=>"prisma-client-js"===e.provider.value)).output.value,m=s.safeParse(e.generator.config);if(!m.success)throw new Error("Incorrect config provided. Please check the values you provided and try again.");const p=m.data,y={clientPath:c,outputPath:d,schemaPath:l},g=n.createSourceFile(`${d}/index.ts`,{},{overwrite:!0});if(((e,t)=>{e.forEach((e=>t.addExportDeclaration({moduleSpecifier:`./${e.name.toLowerCase()}`})))})(r,g),g.formatText({indentSize:2,convertTabsToSpaces:!0,semicolons:a.SemicolonPreference.Remove}),r.forEach((e=>{const r=n.createSourceFile(`${d}/${e.name.toLowerCase()}.ts`,{},{overwrite:!0});((e,a,n,r)=>{((e,a,n,{schemaPath:r,outputPath:i})=>{const{relatedModelName:s}=S(n),l=[{kind:t.StructureKind.ImportDeclaration,namespaceImport:"z",moduleSpecifier:"zod"}];n.enableOpenAPI&&(l.push({kind:t.StructureKind.ImportDeclaration,namedImports:["$Enums"],moduleSpecifier:"@prisma/client"}),l.push({kind:t.StructureKind.ImportDeclaration,namedImports:["extendZodWithOpenApi"],moduleSpecifier:"@anatine/zod-openapi"})),n.generateDto&&l.push({kind:t.StructureKind.ImportDeclaration,namedImports:["createZodDto"],moduleSpecifier:"@anatine/zod-nestjs"}),n.imports&&l.push({kind:t.StructureKind.ImportDeclaration,namespaceImport:"imports",moduleSpecifier:z(o.default.relative(i,o.default.resolve(o.default.dirname(r),n.imports)))}),n.useDecimalJs&&e.fields.some((e=>"Decimal"===e.type))&&l.push({kind:t.StructureKind.ImportDeclaration,namedImports:["Decimal"],moduleSpecifier:"decimal.js"});const d=e.fields.filter((e=>"enum"===e.kind)),c=new Set,m=d.filter((e=>{const t=e.type;return!c.has(t)&&(c.add(t),!0)}));m.length>0&&l.push({kind:t.StructureKind.ImportDeclaration,isTypeOnly:0===m.length,moduleSpecifier:z("enums"),namedImports:m.map((e=>e.type))});const u=e.fields.filter((e=>"object"===e.kind));if(!1!==n.relationModel&&u.length>0){const a=u.filter((t=>t.type!==e.name));a.length>0&&l.push({kind:t.StructureKind.ImportDeclaration,moduleSpecifier:"./index",namedImports:Array.from(new Set(a.flatMap((e=>[`Complete${e.type}`,s(e.type)]))))})}a.addImportDeclarations(l),a.addVariableStatement({declarationKind:t.VariableDeclarationKind.Const,declarations:[{initializer:e=>e.write("extendZodWithOpenApi(z)"),name:"zodOpenApi"}]})})(e,a,n,r),((e,t,a,n)=>{a.useDecimalJs&&e.fields.some((e=>"Decimal"===e.type))&&t.addStatements((e=>{e.newLine(),h(e,["// Helper schema for Decimal fields","z",".instanceof(Decimal)",".or(z.string())",".or(z.number())",".refine((value) => {","  try {","    return new Decimal(value);","  } catch (error) {","    return false;","  }","})",".transform((value) => new Decimal(value));"])}))})(e,a,n),((e,a,n,r)=>{const{modelName:o}=S(n);a.addVariableStatement({declarationKind:t.VariableDeclarationKind.Const,isExported:!0,leadingTrivia:e=>e.blankLineIfLastNot(),declarations:[{name:o(e.name),initializer(t){t.write("z.object(").inlineBlock((()=>{e.fields.filter((e=>"object"!==e.kind)).forEach((e=>{h(t,u(e.documentation)),t.write(`${e.name}: ${f(e)}`).write(",").newLine()}))})).write(")")}}]})})(e,a,n),n.generateDto&&((e,t,a)=>{const{modelName:n,dtoName:r}=S(a);t.addClass({name:r(e.name),isExported:!0,leadingTrivia:e=>e.blankLineIfLastNot(),extends:`createZodDto(${n(e.name)})`})})(e,a,n),((e,t)=>e.fields.some((e=>"object"===e.kind))&&!1!==t.relationModel)(e,n)&&((e,a,n,r)=>{const{modelName:o,relatedModelName:i}=S(n),s=e.fields.filter((e=>"object"===e.kind));a.addInterface({name:`Complete${e.name}`,isExported:!0,extends:[`z.infer<typeof ${o(e.name)}>`],properties:s.map((e=>({hasQuestionToken:!e.isRequired,name:e.name,type:`Complete${e.type}${e.isList?"[]":""}${e.isRequired?"":" | null"}`})))}),a.addStatements((t=>h(t,["","/**",` * ${i(e.name)} contains all relations on your model in addition to the scalars`," *"," * NOTE: Lazy required in case of potential circular dependencies within schema"," */"]))),a.addVariableStatement({declarationKind:t.VariableDeclarationKind.Const,isExported:!0,declarations:[{name:i(e.name),type:`z.ZodSchema<Complete${e.name}>`,initializer(t){t.write(`z.lazy(() => ${o(e.name)}.extend(`).inlineBlock((()=>{s.forEach((e=>{h(t,u(e.documentation)),t.write(`${e.name}?: ${f(e,i)}`).write(",").newLine()}))})).write("))")}}]})})(e,a,n)})(e,r,p,y),r.formatText({indentSize:2,convertTabsToSpaces:!0,semicolons:a.SemicolonPreference.Remove})})),i.length>0){const e=n.createSourceFile(`${d}/enums.ts`,{},{overwrite:!0});((e,t)=>{for(const{name:a,values:n}of e){const e=n.map((({name:e})=>({name:e,value:e})));t.addEnum({name:a,members:e}).setIsExported(!0)}})(i,e),e.formatText({indentSize:2,convertTabsToSpaces:!0,semicolons:a.SemicolonPreference.Remove})}return n.save()}});
//# sourceMappingURL=better-nestjs-zod-prisma.cjs.production.min.js.map
